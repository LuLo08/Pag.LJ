<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Índice de Personajes Marvel - M-Wiki</title>
    <!-- Carga de Tailwind CSS para estilos modernos y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuraciones de fuente y colores base */
        :root {
            --marvel-red: #ED1D24;
            --marvel-blue: #0078FF; /* Usado para enlaces */
            --bg-light: #f9f9f9;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
        }
        
        /* Estilo para los títulos */
        .title-separator {
            border-color: var(--marvel-red);
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- BARRA DE NAVEGACIÓN SUPERIOR (Sticky) -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
            <div class="flex items-center">
                <!-- Logo Wiki -->
                <a href="index.html" class="text-3xl font-extrabold tracking-tight text-red-600">
                    M-Wiki
                </a>
            </div>
            <nav class="hidden md:flex space-x-8">
                <a href="index.html" class="text-gray-600 hover:text-red-600 font-medium transition duration-150 ease-in-out">Personajes</a>
                <a href="#" class="text-gray-600 hover:text-red-600 font-medium transition duration-150 ease-in-out">Equipos</a>
                <a href="#" class="text-gray-600 hover:text-red-600 font-medium transition duration-150 ease-in-out">Comics</a>
            </nav>
            <!-- Barra de Búsqueda -->
            <div class="hidden md:block">
                <input type="search" placeholder="Buscar en M-Wiki..." class="p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500 transition duration-150">
            </div>
        </div>
    </header>

    <!-- CONTENEDOR PRINCIPAL DEL ÍNDICE -->
     <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
        <h1 class="text-4xl font-extrabold mb-6 text-gray-900 border-b-4 title-separator pb-2">Índice de Personajes Marvel</h1>
        
        <p class="text-lg text-gray-600 mb-8">
            Explora nuestra enciclopedia de héroes, villanos y equipos del Universo Marvel. Selecciona un personaje para ver su artículo completo.
        </p>

        <div id="loading-indicator" class="text-center py-10">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-red-600 mx-auto"></div>
            <p class="mt-2 text-red-600 font-semibold">Cargando personajes de Marvel...</p>
        </div>

        <div id="character-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" style="display: none;">
            <!-- El contenido dinámico se insertará aquí -->
        </div>

    </main>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script> 
<script>
    // ⚠ DEBES REEMPLAZAR ESTOS VALORES CON TUS CLAVES REALES DE LA API DE MARVEL
    // SI LAS CLAVES SON CORRECTAS Y SIGUE FALLANDO, EL PROBLEMA ES EL DOMINIO AUTORIZADO (REFERRER).
    const PUBLIC_KEY = 'TU_CLAVE_PUBLICA_AQUI'; // <--- PEGA AQUÍ TU CLAVE PÚBLICA REAL
    const PRIVATE_KEY = 'TU_CLAVE_PRIVADA_AQUI'; // <--- PEGA AQUÍ TU CLAVE PRIVADA REAL
    // FIN DE LAS CLAVES
    
    const BASE_URL = 'https://gateway.marvel.com/v1/public/characters';
    const LIMIT = 12; // Número de personajes a cargar
    
    const characterGrid = document.getElementById('character-grid');
    const loadingIndicator = document.getElementById('loading-indicator');

    /**
     * Genera el hash MD5 requerido para la autenticación de Marvel.
     */
    function generateMarvelAuth() {
        const ts = Date.now().toString();
        // Genera el hash combinando el timestamp, la clave privada y la clave pública.
        // Asegúrate de que la librería md5.min.js esté cargada.
        const hash = md5(ts + PRIVATE_KEY + PUBLIC_KEY); 
        return `ts=${ts}&apikey=${PUBLIC_KEY}&hash=${hash}`;
    }

    /**
     * Crea el HTML para una tarjeta de personaje.
     * @param {Object} character - Objeto de personaje de la respuesta de la API.
     * @returns {string} El HTML de la tarjeta.
     */
    function createCharacterCard(character) {
        // La API de Marvel proporciona la URL de la imagen.
        const imageUrl = `${character.thumbnail.path}.${character.thumbnail.extension}`;
        
        // La descripción es a menudo demasiado larga, la acortamos si es necesario.
        let description = character.description || 'No hay descripción oficial disponible.';
        if (description.length > 80) {
            description = description.substring(0, 80) + '...';
        }
        
        // Obtener el enlace de la Wiki o detalle si existe
        let detailUrl = '#';
        const detailObj = character.urls.find(url => url.type === 'detail' || url.type === 'wiki');
        if (detailObj) {
            detailUrl = detailObj.url;
        }
        
        // La tarjeta ahora enlaza a la URL oficial de Marvel. Usamos target="_blank" para abrir en una pestaña nueva.
        return `
            <a href="${detailUrl}" target="_blank" class="block bg-white border border-gray-300 rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden group">
                <img src="${imageUrl}" 
                    alt="${character.name}" 
                    class="w-full h-48 object-cover transition duration-500 group-hover:scale-105"
                    onerror="this.onerror=null; this.src='https://placehold.co/600x400/ED1D24/ffffff?text=No+Image'">
                <div class="p-4">
                    <h2 class="text-2xl font-bold text-gray-900 group-hover:text-red-600">${character.name}</h2>
                    <p class="text-gray-500 text-sm mt-1">${description}</p>
                </div>
            </a>
        `;
    }

    /**
     * Función principal para cargar y mostrar los personajes.
     */
    async function fetchMarvelCharacters() {
        // 1. Verificación de Claves (Solo para alertar al usuario si no las ha cambiado)
        if (PUBLIC_KEY.includes('41bad4ab676d57615aaca798110d6322') || PRIVATE_KEY.includes('bc7a0cdb5267005937c44be77df739ff152ab656')) {
             loadingIndicator.innerHTML = '<p class="text-lg text-red-600 font-bold">⚠ ERROR: Por favor, reemplaza "TU_CLAVE_PUBLICA_AQUI" y "TU_CLAVE_PRIVADA_AQUI" con tus claves reales de Marvel.</p>';
             loadingIndicator.style.display = 'block';
             return;
        }

        const authParams = generateMarvelAuth();
        const apiQuery = `${BASE_URL}?${authParams}&limit=${LIMIT}&orderBy=name`;
        
        try {
            const response = await fetch(apiQuery);
            
            if (!response.ok) {
                // 2. Manejo de Errores de API (Especialmente 401 Unauthorized)
                const errorData = await response.json();
                let errorMessage = `Error ${response.status}: ${errorData.status || 'No autorizado. Verifica tus claves y el Dominio Autorizado (Referrer).'}`;
                throw new Error(errorMessage);
            }
            
            const data = await response.json();
            const characters = data.data.results;
            
            let charactersHtml = '';
            characters.forEach(character => {
                // Solo renderizamos si la imagen no es la imagen "not available" de Marvel
                if (!character.thumbnail.path.includes('image_not_available')) {
                    charactersHtml += createCharacterCard(character);
                }
            });
            
            // Ocultar el indicador de carga y mostrar la cuadrícula
            loadingIndicator.style.display = 'none';
            characterGrid.innerHTML = charactersHtml;
            characterGrid.style.display = 'grid';

        } catch (error) {
            console.error('Fallo al cargar los datos de Marvel:', error);
            // Mostrar un mensaje de error claro en el indicador de carga
            loadingIndicator.innerHTML = `<p class="text-lg text-red-600 font-bold">
                ⚠ Error al cargar los datos: ${error.message}
            </p>`;
            loadingIndicator.style.display = 'block';
        }
    }

    // Implementación simple de Backoff para manejo de errores de red o límites (opcional pero recomendado)
    // No implementaremos el backoff completo para mantener el código simple, pero es buena práctica.
    
    // Ejecutar la función cuando el DOM esté completamente cargado
    document.addEventListener('DOMContentLoaded', fetchMarvelCharacters);
</script>
</body>
</html>